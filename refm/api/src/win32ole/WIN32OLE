= class WIN32OLE < Object

OLEオートメーションオブジェクトをRubyで操作するためのクラスです。

Windowsの多くのアプリケーションやライブラリは、COMと呼ばれるAPI群を利用して他のプログラムから操作できます。WIN32OLEがサポートしているのは、COMのAPIのうち、特にインタープリタ用のインターフェイスであるOLEオートメーション（IDispatchインターフェイス）とそれに付随するリフレクション用のインターフェイスです。

これらのインターフェイスをサポートしている代表的なWindowsアプリケーションに、Office、IE、iTunes、Illustratorがあります。また、WMI、WshShellなどのライブラリを利用してWindowsの情報を操作することも可能です。

=== サンプルコード

  require 'win32ole'

  excel = WIN32OLE.new('Excel.Application')
  workbook = excel.Workbooks.Open('workbook.xls')
  workbook.PrintOut
  workbook.Close(:SaveChanges => false)
  excel.Quit

#@since 1.9.1

注）以下の記述はWIN32OLEの将来のバージョンの仕様を規定するものではありません。

=== マルチスレッドでの利用制限

WIN32OLEはシングルスレッドモードでCOMとインターフェイスします。このため、ruby 1.9以降のRubyのThreadとネイティブスレッドが1対1で対応する実行環境ではスレッドをまたがる呼び出しはエラーとなります。

  excel = WIN32OLE.new('Excel.Application')
  Thread.start do
    workbook = excel.Workbooks.Open('workbook.xls') #=> HRESULT error code:0x800401f0
    workbook.PrintOut
    workbook.Close(:SaveChanges => false)
  end.join
  excel.Quit

発生するエラーはThreadの実行方法によって0x800401f0（CO_E_NOTINITIALIZED）または0x8001010e（RPC_E_WRONG_THREAD）です。

#@end

== Class Methods

#@since 1.9.1

--- create_guid -> String

GUID(グローバル一意識別子：Global Unique Identifier)を生成します。

GUIDは、COMのクラス識別子(CLSID)、インターフェイス識別子(IID)など多数の領域でWindows上のオブジェクトの識別に利用される128ビットの値です。

WIN32OLEが生成するGUIDは以下の形式によるGUIDの文字列表現です。なお00〜FFはGUIDの先頭からのバイト位置を示します。これはレジストリのキーとして利用される形式です。

  {33221100-5544-7766-8899-AABBCCDDEEFF}

@return GUIDの文字列表現を返します。

   WIN32OLE.create_guid   # => "{????????-????-????-????-????????????}"

--- locale -> Fixnum

WIN32OLEがオートメーション呼び出し時に設定するロケール識別子(LCID)を取得します。

OLEオートメーションでは、UNIXで利用される"ja_JP"などの国名と言語名を「_」で接続した文字列ではなく、32ビット整数で示します。32ビットの内訳は上位16ビットが予約領域で0、下位16ビットが言語ID(LANGID）です。LANGIDは、0〜9ビットでプライマリ言語ID、10〜15ビットでサブ言語IDを示します。

ロード時の既定値は[[m:WIN32OLE::LOCALE_SYSTEM_DEFAULT]]です。

@return WIN32OLEがオートメーション呼び出し時に設定するロケール識別子(LCID)を返します。

   lcid = WIN32OLE.locale

--- locale=(lcid) -> nil

WIN32OLEがオートメーション呼び出し時に設定するロケール識別子(LCID)を設定します。

OLEオートメーションでは、UNIXで利用される"ja_JP"などの国名と言語名を「_」で接続した文字列ではなく、32ビット整数で示します。32ビットの内訳は上位16ビットが予約領域で0、下位16ビットが言語ID(LANGID）です。LANGIDは、0〜9ビットでプライマリ言語ID、10〜15ビットでサブ言語IDを示します。

@param lcid 新たに設定するロケール識別子を整数で指定します。
@raise WIN32OLERuntimeError システムにインストールされていないロケールを指定すると発生します。

   WIN32OLE.locale = 1033 # set locale English(U.S)
   obj = WIN32OLE_VARIANT.new("$100,000", WIN32OLE::VARIANT::VT_CY)

オブジェクトがサポートしていないロケールを設定した場合、オブジェクトのメソッド呼び出し時にDISP_E_UNKNOWNLCID(HRESULT error code:0x8002000C)や、TYPE_E_INVDATAREAD(HRESULT error code:0x80028018)などを理由としたWIN32OLERuntimeError例外となります。ほとんどすべての場合において、既定値を変更する必要はありません。

#@end

--- codepage -> Fixnum

WIN32OLEがOLEオートメーションのインターフェイスに利用するコードページを取得します。

OLEオートメーションに利用する文字列はUnicodeでエンコードします。WIN32OLEはここで示されたコードページを利用してRubyのStringとUnicodeの相互変換を行います。

ロード時の既定値はEncoding.default_internal、またはEncoding.default_internalがnilの場合はEncoding.default_externalによって求めたエンコーディングに対応するコードページです。もし、該当するコードページが見つからない場合は、[[m:WIN32OLE::CP_ACP]]を利用します。

@return WIN32OLEがオートメーション呼び出しの文字列変換に利用するコードページを返します。

   WIN32OLE.codepage   # => 932 （日本語Windowsの既定値）

--- codepage=(cp) -> nil

WIN32OLEがOLEオートメーションのインターフェイスに利用するコードページを設定します。

WIN32OLEは、OLEオートメーション呼び出しに利用する文字列のUnicode変換にここで設定したコードページを利用します。
通常、WIN32OLEはロード時のEncoding.default_internalまたはEncoding.default_externalから適切なコードページを判断し、それを利用します。したがって、当メソッドを呼び出す必要があるのは、WIN32OLEをrequireしたスクリプトと異なるエンコーディングを利用しているスクリプトや、異なるエンコーディングを利用しているファイルから読み込んだ文字列を利用してWIN32OLEを呼び出す場合です。

   WIN32OLE.codepage = WIN32OLE::CP_UTF8

--- connect(ole) -> WIN32OLE

現在実行中のOLEオートメーションサーバに接続します。

connectメソッドは、COMのモニカを利用して、現在実行中のOLEオートメーションサーバを検索し、接続します。接続に成功した場合、該当サーバを操作可能なWIN32OLEオブジェクトが返ります。

@param ole 接続対象のサーバを示すPROGID、CLSIDまたはモニカ（別名）を指定します。

@return ole引数で特定されるWIN32OLEオブジェクトを返します。

   WIN32OLE.connect('Excel.Application') # => WIN32OLE object which represents running Excel.

: PROGID
  OLEオートメーションサーバを識別するための文字列。通常「ベンダー名.アプリケーション名.インターフェイス名」の形式を取ります。レジストリのHKEY_CLASSES_ROOTの「.」で始まらないキーとして登録されます。
: CLSID
  OLEオートメーションサーバを含むCOMのクラスを識別するための128ビットGUID。文字列表現は、レジストリのHKEY_CLASSES_ROOT\CLSID下のキーとして登録されます。
: モニカ
  モニカは、URIのようにWindows上のリソースを一意に識別するためのオブジェクトのインターフェイスで、文字表現を持ちます。詳細については[[url:http://msdn.microsoft.com/en-us/library/ms691261(v=VS.85).aspx]]を参照してください。

--- const_load(ole, mod = WIN32OLE) -> ()

OLEオートメーションサーバが保持する定数を読み込み、指定されたモジュールに組み込みます。

OLEオートメーションサーバは、定数をクライアントへ提供できます。

const_loadメソッドはこれらの定数を読み込み、指定したモジュールに組み込むことで参照可能とします。

@param ole 定数を読み込む対象のWIN32OLEオブジェクトまたはタイプライブラリ名（文字列）を指定します。
@param mod 定数を定義する対象のモジュールを指定します。省略時はWIN32OLEに組み込まれます。

OLEオートメーションの定数は通常、VBのコード規約に準じて、vbConstantsのように小文字で始まります。しかし、Rubyの定数は大文字で開始する規則のため、WIN32OLEによってVbConstantsのように自動的に先頭が大文字化されます。

また、先頭が英字で始まらない定数については、CONSTANTSハッシュに登録されます。この場合、元の定数名がキーとなります。

   module EXCEL_CONST
   end
 
   excel = WIN32OLE.new('Excel.Application')
   WIN32OLE.const_load(excel, EXCEL_CONST)
   puts EXCEL_CONST::XlTop # => -4160
   puts EXCEL_CONST::CONSTANTS['_xlDialogChartSourceData'] # => 541

モジュール名を省略した例

   WIN32OLE.const_load(excel)
   puts WIN32OLE::XlTop # => -4160

タイプライブラリ名を指定した例

   module MSO
   end
 
   WIN32OLE.const_load('Microsoft Office 9.0 Object Library', MSO) 
   puts MSO::MsoLineSingle # => 1

--- new(server, host=nil) -> WIN32OLE
OLEオートメーションサーバを生成します。

引数で指定したCLSIDまたはPROGIDを持つOLEオートメーションサーバを生成します。生成に成功した場合、該当サーバを操作可能なWIN32OLEオブジェクトが返ります。

CLSIDおよびPROGIDについては[[m:WIN32OLE.connect]]を参照してください。

@param server OLEオートメーションサーバを示すPROGIDまたはCLSIDを文字列で指定します。
@param host サーバを生成するホストのホスト名またはIPアドレスを文字列で指定します。
            省略時は現在スクリプトを実行中のホストで生成します。

    WIN32OLE.new('Excel.Application') # => Excel OLE Automation WIN32OLE object.

    WIN32OLE.new('{00024500-0000-0000-C000-000000000046}') # => Excel OLE Automation WIN32OLE object.

--- ole_free(aWIN32OLE) -> Integer

引数で指定したオブジェクトを解放します。

このメソッドは主にWIN32OLEのデバッグおよびWIN32OLEを利用するミドルウェアの実装のために用意されています。このため、メソッドの内部動作は不定です。
COMの仕様とWIN32OLEの内部処理に熟知していない場合は使用しないでください。

@param aWIN32OLE 解放するWIN32OLEオブジェクト。
@return Releaseの戻り値。COMの仕様上は現在のオブジェクトの参照カウント値を示します。

--- ole_reference_count(aWIN32OLE) -> Integer

引数で指定したオブジェクトの現在の参照カウント値を返します。

このメソッドは主にWIN32OLEのデバッグおよびWIN32OLEを利用するミドルウェアの実装のために用意されています。このため、メソッドの内部動作は不定です。
COMの仕様とWIN32OLEの内部処理に熟知していない場合は使用しないでください。

@param aWIN32OLE 参照カウント値を求めるWIN32OLEオブジェクト。
@return AddRef呼び出し後のReleaseの戻り値。COMの仕様上は現在のオブジェクトの参照カウント値を示します。

--- ole_show_help(obj, helpcontext = nil) -> ()
WIN32OLEオブジェクトのヘルプファイルを表示します。

Windows標準のヘルプ表示コンポーネントのHHCtrl.OCXを利用して、オブジェクトに関連付けられたヘルプファイル（chmファイル）を表示します。

また、chmファイルのフルパス名を指定して表示させることも可能です。

@param obj [[c:WIN32OLE_TYPE]]オブジェクトまたは[[c:WIN32OLE_METHOD]]オブジェクト。
           直接ヘルプファイルのフルパス名を指定することも可能です。
@param helpcontext obj引数に[[c:WIN32OLE_TYPE]]オブジェクトまたは[[c:WIN32OLE_METHOD]]オブジェクトを指定した場合は、これらのオブジェクトの設定値を利用するため指定不要です。
                   obj引数にヘルプファイルのフルパス名を設定した場合は0を指定してください。

   excel = WIN32OLE.new('Excel.Application')
   typeobj = excel.ole_obj_help
   WIN32OLE.ole_show_help(typeobj) if typeobj.helpfile

オブジェクトが関連するヘルプファイルを持たない場合はRuntimeError（no helpfile of `オブジェクト名')を通知します。また、ヘルプファイルがインストールされていない場合は、RuntimeError（failed to open help file `ファイル名'）が通知されます。

== Instance Methods

--- [](property)
#@todo

Returns property of OLE object.

   excel = WIN32OLE.new('Excel.Application')
   puts excel['Visible'] # => false

--- _getproperty(dispid, args, types)
#@todo

Runs the early binding method to get property. The 1st argument
specifies dispatch ID, the 2nd argument specifies the array of
arguments, the 3rd argument specifies the array of the type of
arguments.

   excel = WIN32OLE.new('Excel.Application')
   puts excel._getproperty(558, [], []) # same effect as puts excel.visible

--- _invoke(dispid, args, types)
#@todo

Runs the early binding method. The 1st argument specifies dispatch
ID, the 2nd argument specifies the array of arguments, the 3rd
argument specifies the array of the type of arguments.

   excel = WIN32OLE.new('Excel.Application')
   excel._invoke(302, [], []) #  same effect as excel.Quit

--- _setproperty(dispid, args, types)
#@todo

Runs the early binding method to set property. The 1st argument
specifies dispatch ID, the 2nd argument specifies the array of
arguments, the 3rd argument specifies the array of the type of
arguments.

   excel = WIN32OLE.new('Excel.Application')
   excel._setproperty(558, [true], [WIN32OLE::VARIANT::VT_BOOL]) # same effect as excel.visible = true

--- each {|i|...}
#@todo

Iterates over each item of OLE collection which has IEnumVARIANT
interface.

   excel = WIN32OLE.new('Excel.Application')
   book = excel.workbooks.add
   sheets = book.worksheets(1)
   cells = sheets.cells("A1:A5")
   cells.each do |cell|
     cell.value = 10
   end

--- invoke(method, *args)  -> return value of method.
#@todo

Runs OLE method. The first argument specifies the method name
of OLE Automation object. The others specify argument of the
method. If you can not execute method directly, then use this
method instead.

  excel = WIN32OLE.new('Excel.Application')
  excel.invoke('Quit')  # => same as excel.Quit

--- method_missing(id, *args)
#@todo

Calls WIN32OLE#invoke method.

--- ole_activex_initialize -> Qnil
#@todo

Initialize WIN32OLE object(ActiveX Control) by calling IPersistMemory::InitNew.

Before calling OLE method, some kind of the ActiveX controls
created with MFC should be initialized by calling IPersistXXX::InitNew.

If and only if you recieved the exception "HRESULT error code:
0x8000ffff catastrophic failure", try this method before invoking
any ole_method.

   obj = WIN32OLE.new("ProgID_or_GUID_of_ActiveX_Control")
   obj.ole_activex_initialize
   obj.method(...)

--- ole_free -> ()

selfが参照するCOMオブジェクトを解放します。

selfが参照するCOMオブジェクトのIUnknown::Releaseを呼び出すことで、COMオブジェクトを開放します。
ole_freeを呼び出した後は、このオブジェクトに対する操作は行えません。

  excel = WIN32OLE.new('Excel.Application')
  excel.ole_free  # オブジェクトの解放
  excel.Quit      #=> RuntimeError (failed to get Dispatch Interface)

通常は利用されなくなったWIN32OLEオブジェクトはGCのタイミングで自動的に解放されるため、当メソッドを呼び出す必要はありません。Officeのような外部プロセスサーバ呼び出し時に、スクリプト終了後もサーバが解放されない場合に強制的にサーバを終了するために当メソッドを利用できます。
ただし、現実には途中で生成される子オブジェクトからの逆参照などがあるため、WIN32OLEがIUnknown::Releaseを呼び出してもオブジェクトが解放されるとは限りません。

  excel = WIN32OLE.new('Excel.Application')
  workbook = excel.Workbooks.Open('workbook.xls') 
  workbook.Close(:SaveChanges => false)
  workbook.ole_free
  excel.ole_free
  # この時点でExcel.EXEは終了しない

上の例では、excel.Workbooks.Openの行で、excel.Workbooksオブジェクトが生成されています。しかし、後続の処理で該当オブジェクトが解放されていないため、Workbooksオブジェクトによって参照されているexcelオブジェクトは解放されません。
それに対して下の例では正しく解放されます。

  excel = WIN32OLE.new('Excel.Application')
  books = excel.Workbooks
  workbook = books.Open('workbook.xls')
  books.ole_free
  workbook.Close(:SaveChanges => false)
  workbook.ole_free
  excel.ole_free

--- ole_func_methods
#@todo

Returns the array of WIN32OLE_METHOD object . The element of
the array is functional method of WIN32OLE object.

   excel = WIN32OLE.new('Excel.Application')
   properties = excel.ole_func_methods

--- ole_get_methods
#@todo

Returns the array of WIN32OLE_METHOD object . The element of
the array is property (gettable) of WIN32OLE object.

   excel = WIN32OLE.new('Excel.Application')
   properties = excel.ole_get_methods

--- ole_method_help(method)
#@todo
alias ole_method_help

Returns WIN32OLE_METHOD object corresponding with method specified
by 1st argument.

   excel = WIN32OLE.new('Excel.Application')
   method = excel.ole_method_help('Quit')

--- ole_method_help(method)
#@todo
alias ole_method_help

Returns WIN32OLE_METHOD object corresponding with method specified
by 1st argument.

   excel = WIN32OLE.new('Excel.Application')
   method = excel.ole_method_help('Quit')

--- ole_methods
#@todo

Returns the array of WIN32OLE_METHOD object. The element is OLE
method of WIN32OLE object.

   excel = WIN32OLE.new('Excel.Application')
   methods = excel.ole_methods

--- ole_obj_help -> WIN32OLE_TYPE | nil
[[c:WIN32OLE_TYPE]]オブジェクトを返します。

[[c:WIN32OLE_TYPE]]オブジェクトは、WIN32OLEオブジェクトの文書情報と型情報を保持するオブジェクトです。

@return オブジェクトに関連する[[c:WIN32OLE_TYPE]]オブジェクトを返します。
        オブジェクトがドキュメント情報を持たない場合はnilを返します。

   excel = WIN32OLE.new('Excel.Application')
   tobj = excel.ole_obj_help

--- ole_put_methods
#@todo

Returns the array of WIN32OLE_METHOD object . The element of
the array is property (settable) of WIN32OLE object.

   excel = WIN32OLE.new('Excel.Application')
   properties = excel.ole_put_methods

--- []=(property, val)
--- setproperty('property', [arg1, arg2,...] val)
#@todo

Sets property of OLE object. When you want to set property with
argument, you can use this method.

   excel = WIN32OLE.new('Excel.Application')
   excel['Visible'] = true
   book = excel.workbooks.add
   sheet = book.worksheets(1)
   sheet.setproperty('Cells', 1, 2, 10) # => The B1 cell value is 10.

#@since 1.9.1

--- ole_query_interface(iid) -> WIN32OLE object
#@todo

Returns WIN32OLE object for a specific dispatch or dual interface
specified by iid.

    ie = WIN32OLE.new('InternetExplorer.Application')
    ie_web_app = ie.ole_query_interface('{0002DF05-0000-0000-C000-000000000046}') # => WIN32OLE object for dispinterface IWebBrowserApp

--- ole_type -> WIN32OLE_TYPE | nil
[[c:WIN32OLE_TYPE]]オブジェクトを返します。

このメソッドは、[[m:WIN32OLE#ole_obj_help]]メソッドのエイリアスです。

@return オブジェクトに関連する[[c:WIN32OLE_TYPE]]オブジェクトを返します。
        オブジェクトがドキュメント情報を持たない場合はnilを返します。

   excel = WIN32OLE.new('Excel.Application')
   tobj = excel.ole_type

--- ole_typelib -> The WIN32OLE_TYPELIB object 
#@todo

Returns the WIN32OLE_TYPELIB object. The object represents the
type library which contains the WIN32OLE object.

   excel = WIN32OLE.new('Excel.Application')
   tlib = excel.ole_typelib
   puts tlib.name  # -> 'Microsoft Excel 9.0 Object Library'

#@end

== Constants
--- VERSION  -> String

Major.Minor.Patch形式のWIN32OLEのバージョン番号を示す文字列です。

--- ARGV -> [object]

直前のメソッド呼び出しの引数を格納した配列です。

OLEオートメーションでは呼び出し先が引数に対して値を設定できます。しかし、Rubyのメソッド引数は値のみを取るため、そのままでは呼び出し先が設定した値を参照できません。このような場合、ARGVを参照することで呼び出し先の設定値を参照できます。

以下のリストは、VBで開発したオブジェクトのメソッド呼び出しを例としています。このメソッド（Accm）は、第1引数で指定した演算を第2引数と第3引数に適用し、結果を第2引数に設定します。

  ' VB (OLE Automation server)
  Public Sub Accm(ByVal Operator, ByRef Accumulator, ByVal Operand)
      If Operator = "*" Then
          Accmulator = Accmulator * Operand
      Else If Operator = "+" Then
          Accmulator = Accmulator + Operand
      End If
  End Sub
 
  # Ruby
  x = 10
  obj.Accm '*', x, 11
  p x               # -> 10 …… 呼び出しによって影響を受けない
  p WIN32OLE::ARGV  # -> ['*', 110, 11] …… 結果はARGVの対応する引数に反映される
  obj.Accm '+', 10, 11
  p WIN32OLE::ARGV  # -> ['+', 21, 11]

直前のメソッド呼び出しが例外となった場合、ARGVの設定内容は呼び出し前の状態が保たれます。つまり、WIN32OLE自身がARGVの内容を消去するのは、メソッド呼び出しに成功した場合のみです。このため最後のメソッド呼び出しが引数にオブジェクトを返すタイプのメソッドだった場合、GCにオブジェクトを回収させるために、呼び出し側でARGVを消去してください。

  ' VB (OLE Automation server)
  Public Sub GetInterface(ByRef obj)
      Set Obj = New OleObject
  End Sub

  # Ruby
  obj.GetInterface nil   # 引数の数を合わせるためダミー引数を指定
  WIN32OLE::ARGV.clear   # 通常は、後続のメソッド呼び出しによって消去される

--- CP_ACP -> Fixnum

Windows既定のANSIコードページ（0）を示します。

--- CP_MACCP -> Fixnum

Macintoshコードページ（2）を示します。

--- CP_OEMCP -> Fixnum

OEMコードページ（1）を示します。

--- CP_SYMBOL -> Fixnum

文字コードの変換にシンボルを利用することを示します（42）。

--- CP_THREAD_ACP -> Fixnum

現在実行中のスレッドの既定のコードページ（3）を示します。

Windowsのコードページはスレッド毎に異なる値を設定できます。

--- CP_UTF7 -> Fixnum

文字コードの変換にUTF-7を利用することを示します（65000）。

--- CP_UTF8 -> Fixnum

文字コードの変換にUTF-8を利用することを示します（65001）。

--- LOCALE_SYSTEM_DEFAULT  -> Fixnum

システム既定のロケールを示すLCID(0x0800)です。WIN32OLEがオートメーションを利用する場合の既定値です。

--- LOCALE_USER_DEFAULT  -> Fixnum

ユーザ既定のロケールを示すLCID(0x0400)です。
